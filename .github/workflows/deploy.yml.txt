name: üöÄ Deploy Ravikumar Cloud Portfolio

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-south-2
  DYNAMO_TABLE_NAME: Resume
  LAMBDA_NAME: Resume-challange
  SNS_TOPIC_ARN: arn:aws:sns:ap-south-2:358238714507:Resume-SNS
  API_ID: q0rz3eyl6c
  S3_BUCKET_NAME: cloudresume-portfolio
  CLOUDFRONT_DOMAIN: d20dywo6lz1slm.cloudfront.net
  ACCOUNT_ID: 358238714507

jobs:
  deploy:
    name: Deploy to AWS via IAM Role (OIDC)
    runs-on: ubuntu-latest

    permissions:
      id-token: write   # Required for OIDC
      contents: read    # To fetch repo contents

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîê Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::358238714507:role/GitHubDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: üì¶ Deploy DynamoDB Stack
        run: |
          aws cloudformation deploy \
            --template-file templates/dynamodb.yaml \
            --stack-name resume-ddb-stack \
            --parameter-overrides ResumeTableName=$DYNAMO_TABLE_NAME \
            --capabilities CAPABILITY_NAMED_IAM

      - name: ‚öôÔ∏è Deploy Lambda Stack
        run: |
          aws cloudformation deploy \
            --template-file templates/lambda.yaml \
            --stack-name resume-lambda-stack \
            --parameter-overrides \
              ResumeTableName=$DYNAMO_TABLE_NAME \
              VisitorLambdaName=$LAMBDA_NAME \
              SNSTopicArn=$SNS_TOPIC_ARN \
              S3BucketName=$S3_BUCKET_NAME \
            --capabilities CAPABILITY_NAMED_IAM

      - name: üåê Deploy API Gateway Stack
        run: |
          aws cloudformation deploy \
            --template-file templates/api-gateway.yaml \
            --stack-name resume-api-stack \
            --parameter-overrides \
              ApiId=$API_ID \
              VisitorLambdaName=$LAMBDA_NAME

      - name: üóÇ Deploy S3 + CloudFront Stack
        run: |
          aws cloudformation deploy \
            --template-file templates/s3-cloudfront.yaml \
            --stack-name resume-web-stack \
            --parameter-overrides \
              S3BucketName=$S3_BUCKET_NAME \
              CloudFrontDomain=$CLOUDFRONT_DOMAIN

      - name: üìä Deploy CloudWatch Alarm Stack
        run: |
          aws cloudformation deploy \
            --template-file templates/sns-alarm.yaml \
            --stack-name resume-alarm-stack \
            --parameter-overrides \
              ResumeTableName=$DYNAMO_TABLE_NAME \
              VisitorLambdaName=$LAMBDA_NAME \
              SNSTopicArn=$SNS_TOPIC_ARN

      - name: üîí Deploy IAM Role for API Gateway Logs
        run: |
          aws cloudformation deploy \
            --template-file templates/iam.yaml \
            --stack-name resume-iam-stack \
            --parameter-overrides AccountID=$ACCOUNT_ID \
            --capabilities CAPABILITY_NAMED_IAM
